// ìš´ì˜í™˜ê²½ìš© Jenkins íŒŒì´í”„ë¼ì¸
// ì´ íŒŒì¼ì€ ìš´ì˜ PCì˜ Jenkinsì—ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.

pipeline {
    agent { label 'ec2-worker-ubuntu' }
    
    environment {
        // Docker Registry ì„¤ì • (ìš´ì˜í™˜ê²½ìš©)
        DOCKER_REGISTRY = 'docker.io'  // Docker Hub
        DOCKERHUB_USERNAME = "${env.DOCKER_HUB_USERNAME}"  // Jenkins í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´
        IMAGE_NAME = 'trip-service'

        // AWS ECR ì„¤ì •
        AWS_REGION = 'ap-northeast-2'
        ECR_REGISTRY = "${env.AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com"  // Jenkins í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´
        
        // í™˜ê²½ë³„ ì´ë¯¸ì§€ íƒœê·¸
        DEV_TAG = "dev-${env.BUILD_NUMBER}"
        PROD_TAG = "prod-${env.BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "ğŸ“ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì¤‘..."
                checkout scm
            }
        }
        
        stage('Build & Test') {
            parallel {
                stage('Frontend Build & Test') {
                    steps {
                        echo "ğŸ”¨ Frontend ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì¤‘..."
                        dir('frontend') {
                            sh '''
                                npm install --legacy-peer-deps
                                npm run build
                                npm run test
                            '''
                        }
                    }
                }
                
                stage('Currency Service Test') {
                    steps {
                        echo "ğŸ”¨ Currency Service í…ŒìŠ¤íŠ¸ ì¤‘..."
                        dir('service-currency') {
                            sh '''
                                if [ -d "tests" ]; then
                                    python -m pytest tests/ -v
                                else
                                    echo "âš ï¸ í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
                                fi
                            '''
                        }
                    }
                }
                
                stage('History Service Test') {
                    steps {
                        echo "ğŸ”¨ History Service í…ŒìŠ¤íŠ¸ ì¤‘..."
                        dir('service-history') {
                            sh '''
                                if [ -d "tests" ]; then
                                    python -m pytest tests/ -v
                                else
                                    echo "âš ï¸ í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
                                fi
                            '''
                        }
                    }
                }
                
                stage('Ranking Service Test') {
                    steps {
                        echo "ğŸ”¨ Ranking Service í…ŒìŠ¤íŠ¸ ì¤‘..."
                        dir('service-ranking') {
                            sh '''
                                if [ -d "tests" ]; then
                                    python -m pytest tests/ -v
                                else
                                    echo "âš ï¸ í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
                                fi
                            '''
                        }
                    }
                }
                
                stage('Data Ingestor Test') {
                    steps {
                        echo "ğŸ”¨ Data Ingestor í…ŒìŠ¤íŠ¸ ì¤‘..."
                        dir('service-dataingestor') {
                            sh '''
                                if [ -d "tests" ]; then
                                    python -m pytest tests/ -v
                                else
                                    echo "âš ï¸ í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
                                fi
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Docker Build & Push') {
            parallel {
                stage('Frontend Image') {
                    steps {
                        echo "ğŸ³ Frontend Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                        dir('frontend') {
                            script {
                                // ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì¬ì‹œë„ ë¡œì§
                                def image
                                def retryCount = 0
                                def maxRetries = 3
                                
                                while (retryCount < maxRetries) {
                                    try {
                                        image = docker.build("${DOCKERHUB_USERNAME}/${IMAGE_NAME}-frontend:${PROD_TAG}")
                                        break
                                    } catch (Exception e) {
                                        retryCount++
                                        if (retryCount < maxRetries) {
                                            echo "âš ï¸ Docker ë¹Œë“œ ì‹¤íŒ¨, ${retryCount}/${maxRetries} ì¬ì‹œë„ ì¤‘..."
                                            sleep(10)
                                        } else {
                                            throw e
                                        }
                                    }
                                }

                                // Docker Hubì— í‘¸ì‹œ (Access Token ì‚¬ìš©)
                                docker.withRegistry("https://${DOCKER_REGISTRY}", 'dockerhub-credentials') {
                                    image.push()
                                    image.push('latest')
                                }

                                // AWS ECRì— í‘¸ì‹œ (IAM Role ì‚¬ìš©)
                                withAWS(region: AWS_REGION) {
                                    sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}"
                                    def ecrImage = docker.build("${ECR_REGISTRY}/${IMAGE_NAME}-frontend:${PROD_TAG}")
                                    ecrImage.push()
                                    ecrImage.push('latest')
                                }
                            }
                        }
                    }
                }
                
                stage('Currency Service Image') {
                    steps {
                        echo "ğŸ³ Currency Service Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                        dir('service-currency') {
                            script {
                                def image = docker.build("${DOCKERHUB_USERNAME}/${IMAGE_NAME}-currency:${PROD_TAG}")

                                // Docker Hubì— í‘¸ì‹œ (Access Token ì‚¬ìš©)
                                docker.withRegistry("https://${DOCKER_REGISTRY}", 'dockerhub-credentials') {
                                    image.push()
                                    image.push('latest')
                                }

                                // AWS ECRì— í‘¸ì‹œ (IAM Role ì‚¬ìš©)
                                withAWS(region: AWS_REGION) {
                                    sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}"
                                    def ecrImage = docker.build("${ECR_REGISTRY}/${IMAGE_NAME}-currency:${PROD_TAG}")
                                    ecrImage.push()
                                    ecrImage.push('latest')
                                }
                            }
                        }
                    }
                }
                
                stage('History Service Image') {
                    steps {
                        echo "ğŸ³ History Service Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                        dir('service-history') {
                            script {
                                def image = docker.build("${DOCKERHUB_USERNAME}/${IMAGE_NAME}-history:${PROD_TAG}")

                                // Docker Hubì— í‘¸ì‹œ (Access Token ì‚¬ìš©)
                                docker.withRegistry("https://${DOCKER_REGISTRY}", 'dockerhub-credentials') {
                                    image.push()
                                    image.push('latest')
                                }

                                // AWS ECRì— í‘¸ì‹œ (IAM Role ì‚¬ìš©)
                                withAWS(region: AWS_REGION) {
                                    sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}"
                                    def ecrImage = docker.build("${ECR_REGISTRY}/${IMAGE_NAME}-history:${PROD_TAG}")
                                    ecrImage.push()
                                    ecrImage.push('latest')
                                }
                            }
                        }
                    }
                }
                
                stage('Ranking Service Image') {
                    steps {
                        echo "ğŸ³ Ranking Service Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                        dir('service-ranking') {
                            script {
                                def image = docker.build("${DOCKERHUB_USERNAME}/${IMAGE_NAME}-ranking:${PROD_TAG}")

                                // Docker Hubì— í‘¸ì‹œ (Access Token ì‚¬ìš©)
                                docker.withRegistry("https://${DOCKER_REGISTRY}", 'dockerhub-credentials') {
                                    image.push()
                                    image.push('latest')
                                }

                                // AWS ECRì— í‘¸ì‹œ (IAM Role ì‚¬ìš©)
                                withAWS(region: AWS_REGION) {
                                    sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}"
                                    def ecrImage = docker.build("${ECR_REGISTRY}/${IMAGE_NAME}-ranking:${PROD_TAG}")
                                    ecrImage.push()
                                    ecrImage.push('latest')
                                }
                            }
                        }
                    }
                }
                
                stage('Data Ingestor Image') {
                    steps {
                        echo "ğŸ³ Data Ingestor Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                        dir('service-dataingestor') {
                            script {
                                def image = docker.build("${DOCKERHUB_USERNAME}/${IMAGE_NAME}-dataingestor:${PROD_TAG}")

                                // Docker Hubì— í‘¸ì‹œ (Access Token ì‚¬ìš©)
                                docker.withRegistry("https://${DOCKER_REGISTRY}", 'dockerhub-credentials') {
                                    image.push()
                                    image.push('latest')
                                }

                                // AWS ECRì— í‘¸ì‹œ (IAM Role ì‚¬ìš©)
                                withAWS(region: AWS_REGION) {
                                    sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}"
                                    def ecrImage = docker.build("${ECR_REGISTRY}/${IMAGE_NAME}-dataingestor:${PROD_TAG}")
                                    ecrImage.push()
                                    ecrImage.push('latest')
                                }
                            }
                        }
                    }
                }
            }
        }
        
        // Deploy to Production Kubernetes - ì£¼ì„ ì²˜ë¦¬ë¨
        // stage('Deploy to Production Kubernetes') {
        //     steps {
        //         echo "ğŸš€ ìš´ì˜ Kubernetes í´ëŸ¬ìŠ¤í„° ë°°í¬ ì¤‘..."
        //         script {
        //             // Kubernetes í´ëŸ¬ìŠ¤í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        //             def k8sAvailable = false
        //             try {
        //                 sh '''
        //                     // Kubernetes í´ëŸ¬ìŠ¤í„° ì—°ê²° í™•ì¸
        //                     kubectl cluster-info
        //                     kubectl get nodes
        //                 '''
        //                 k8sAvailable = true
        //                 echo "âœ… Kubernetes í´ëŸ¬ìŠ¤í„°ê°€ ì •ìƒì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."
        //             } catch (Exception e) {
        //                 echo "âš ï¸ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        //                 echo "ğŸ“¦ Docker Hubì™€ ECRì— ì´ë¯¸ì§€ë§Œ ì €ì¥í•˜ê³  ë°°í¬ëŠ” ê±´ë„ˆëœë‹ˆë‹¤."
        //                 k8sAvailable = false
        //             }
        //
        //             if (k8sAvailable) {
        //                 if (env.BRANCH_NAME == 'main') {
        //                     // í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬
        //                     sh '''
        //                         // ìš´ì˜ Kubernetes í´ëŸ¬ìŠ¤í„° í™•ì¸
        //                         kubectl get nodes
        //                         kubectl get pods -n trip-service-prod
        //
        //                         // ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
        //                         kubectl set image deployment/service-frontend service-frontend=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-frontend:${PROD_TAG} -n trip-service-prod
        //                         kubectl set image deployment/service-currency service-currency=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-currency:${PROD_TAG} -n trip-service-prod
        //                         kubectl set image deployment/service-history service-history=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-history:${PROD_TAG} -n trip-service-prod
        //                         kubectl set image deployment/service-ranking service-ranking=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-ranking:${PROD_TAG} -n trip-service-prod
        //                         kubectl set image deployment/service-dataingestor service-dataingestor=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-dataingestor:${PROD_TAG} -n trip-service-prod
        //
        //                         // ë°°í¬ ìƒíƒœ í™•ì¸
        //                         kubectl rollout status deployment/service-frontend -n trip-service-prod
        //                         kubectl rollout status deployment/service-currency -n trip-service-prod
        //                         kubectl rollout status deployment/service-history -n trip-service-prod
        //                         kubectl rollout status deployment/service-ranking -n trip-service-prod
        //                         kubectl rollout status deployment/service-dataingestor -n trip-service-prod
        //                     '''
        //                 } else {
        //                     // ê°œë°œ í™˜ê²½ ë°°í¬
        //                     sh '''
        //                         // ê°œë°œ Kubernetes í´ëŸ¬ìŠ¤í„° í™•ì¸
        //                         kubectl get nodes
        //                         kubectl get pods -n trip-service-dev
        //
        //                         // ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
        //                         kubectl set image deployment/service-frontend service-frontend=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-frontend:${DEV_TAG} -n trip-service-dev
        //                         kubectl set image deployment/service-currency service-currency=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-currency:${DEV_TAG} -n trip-service-dev
        //                         kubectl set image deployment/service-history service-history=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-history:${DEV_TAG} -n trip-service-dev
        //                         kubectl set image deployment/service-ranking service-ranking=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-ranking:${DEV_TAG} -n trip-service-dev
        //                         kubectl set image deployment/service-dataingestor service-dataingestor=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-dataingestor:${DEV_TAG} -n trip-service-dev
        //
        //                         // ë°°í¬ ìƒíƒœ í™•ì¸
        //                         kubectl rollout status deployment/service-frontend -n trip-service-dev
        //                         kubectl rollout status deployment/service-currency -n trip-service-dev
        //                         kubectl rollout status deployment/service-history -n trip-service-dev
        //                         kubectl rollout status deployment/service-ranking -n trip-service-dev
        //                         kubectl rollout status deployment/service-dataingestor -n trip-service-dev
        //                     '''
        //                 }
        //             } else {
        //                 echo "ğŸ“¦ Kubernetes í´ëŸ¬ìŠ¤í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        //                 echo "âœ… Docker Hubì™€ ECRì— ì´ë¯¸ì§€ë§Œ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
        //                 echo "ğŸ”— ì €ì¥ëœ ì´ë¯¸ì§€ë“¤:"
        //                 echo "   - Docker Hub: ${DOCKERHUB_USERNAME}/${IMAGE_NAME}-*:${PROD_TAG}"
        //                 echo "   - AWS ECR: ${ECR_REGISTRY}/${IMAGE_NAME}-*:${PROD_TAG}"
        //                 echo "ğŸ’¡ Kubernetes í´ëŸ¬ìŠ¤í„°ê°€ ì¤€ë¹„ë˜ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:"
        //                 echo "   kubectl set image deployment/service-frontend service-frontend=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-frontend:${PROD_TAG} -n trip-service-prod"
        //                 echo "   kubectl set image deployment/service-currency service-currency=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-currency:${PROD_TAG} -n trip-service-prod"
        //                 echo "   kubectl set image deployment/service-history service-history=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-history:${PROD_TAG} -n trip-service-prod"
        //                 echo "   kubectl set image deployment/service-ranking service-ranking=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-ranking:${PROD_TAG} -n trip-service-prod"
        //                 echo "   kubectl set image deployment/service-dataingestor service-dataingestor=${DOCKERHUB_USERNAME}/${IMAGE_NAME}-dataingestor:${PROD_TAG} -n trip-service-prod"
        //             }
        //         }
        //     }
        // }
        
        // Health Check - ì£¼ì„ ì²˜ë¦¬ë¨
        // stage('Health Check') {
        //     steps {
        //         echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ìˆ˜í–‰ ì¤‘..."
        //         script {
        //             // Kubernetes í´ëŸ¬ìŠ¤í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        //             def k8sAvailable = false
        //             try {
        //                 sh '''
        //                     // Kubernetes í´ëŸ¬ìŠ¤í„° ì—°ê²° í™•ì¸
        //                     kubectl cluster-info
        //                     kubectl get nodes
        //                 '''
        //                 k8sAvailable = true
        //             } catch (Exception e) {
        //                 echo "âš ï¸ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        //                 echo "ğŸ“¦ í—¬ìŠ¤ ì²´í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
        //                 k8sAvailable = false
        //             }
        //
        //             if (k8sAvailable) {
        //                 if (env.BRANCH_NAME == 'main') {
        //                     // í”„ë¡œë•ì…˜ í™˜ê²½ í—¬ìŠ¤ ì²´í¬
        //                     sh '''
        //                         // ì„œë¹„ìŠ¤ í—¬ìŠ¤ ì²´í¬
        //                         kubectl get pods -n trip-service-prod
        //                         kubectl get services -n trip-service-prod
        //
        //                         // API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        //                         kubectl run health-check --image=curlimages/curl -i --tty --rm -n trip-service-prod -- sh -c "
        //                             curl -f http://service-currency:8000/health || exit 1
        //                             curl -f http://service-history:8000/health || exit 1
        //                             curl -f http://service-ranking:8000/health || exit 1
        //                             curl -f http://service-dataingestor:8000/health || exit 1
        //                         "
        //                     '''
        //                 } else {
        //                     // ê°œë°œ í™˜ê²½ í—¬ìŠ¤ ì²´í¬
        //                     sh '''
        //                         // ì„œë¹„ìŠ¤ í—¬ìŠ¤ ì²´í¬
        //                         kubectl get pods -n trip-service-dev
        //                         kubectl get services -n trip-service-dev
        //
        //                         // API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        //                         kubectl run health-check --image=curlimages/curl -i --tty --rm -n trip-service-dev -- sh -c "
        //                             curl -f http://service-currency:8000/health || exit 1
        //                             curl -f http://service-history:8000/health || exit 1
        //                             curl -f http://service-ranking:8000/health || exit 1
        //                             curl -f http://service-dataingestor:8000/health || exit 1
        //                         "
        //                     '''
        //                 }
        //             } else {
        //                 echo "ğŸ“¦ Kubernetes í´ëŸ¬ìŠ¤í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        //                 echo "âœ… í—¬ìŠ¤ ì²´í¬ë¥¼ ê±´ë„ˆë›°ê³  íŒŒì´í”„ë¼ì¸ì„ ì™„ë£Œí•©ë‹ˆë‹¤."
        //             }
        //         }
        //     }
        // }
    }
    
    post {
        always {
            echo "ğŸ§¹ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰ ì¤‘..."
            cleanWs()
        }
        
        success {
            echo "âœ… íŒŒì´í”„ë¼ì¸ ì„±ê³µ! Docker Hubì™€ ECR ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
            // Slack ì•Œë¦¼ì€ Jenkinsì—ì„œ ë³„ë„ ì„¤ì • í•„ìš”
            // slackSend(
            //     channel: '#production',
            //     color: 'good',
            //     message: "âœ… ${env.JOB_NAME} - ${env.BUILD_NUMBER} ë¹Œë“œ ë° ì´ë¯¸ì§€ í‘¸ì‹œ ì„±ê³µ!\nì´ë¯¸ì§€ íƒœê·¸: ${PROD_TAG}"
            // )
        }
        
        failure {
            echo "âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨! ë¹Œë“œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            // Slack ì•Œë¦¼ì€ Jenkinsì—ì„œ ë³„ë„ ì„¤ì • í•„ìš”
            // slackSend(
            //     channel: '#production',
            //     color: 'danger',
            //     message: "âŒ ${env.JOB_NAME} - ${env.BUILD_NUMBER} ë¹Œë“œ ë˜ëŠ” ì´ë¯¸ì§€ í‘¸ì‹œ ì‹¤íŒ¨!\në¡œê·¸ í™•ì¸: ${env.BUILD_URL}"
            // )
        }
    }
}
